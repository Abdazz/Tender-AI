# Apache2 Virtual Host Configuration for TenderAI BF
# 
# This configuration proxies HTTPS traffic from Apache2 (port 443)
# to the Nginx Docker container (port 8080)
#
# Installation:
#   sudo cp infra/apache2/tender-ai.yulcom.net.conf /etc/apache2/sites-available/tender-ai.yulcom.net.conf
#   sudo a2enmod proxy proxy_http proxy_wstunnel ssl headers rewrite
#   sudo systemctl reload apache2

<VirtualHost *:80>
    ServerName tender-ai.yulcom.net
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
    
    ErrorLog ${APACHE_LOG_DIR}/tender-ai.yulcom.net-error.log
    CustomLog ${APACHE_LOG_DIR}/tender-ai.yulcom.net-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName tender-ai.yulcom.net
    
    # SSL Configuration (existing Let's Encrypt certificates)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/tender-ai.yulcom.net/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/tender-ai.yulcom.net/privkey.pem
    
    # Modern SSL configuration
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # Security Headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Proxy Configuration - Forward to Nginx Docker container
    ProxyPreserveHost On
    ProxyRequests Off
    
    # SSL proxy configuration for HTTPS backend
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
    
    # Proxy to Nginx Docker container (localhost:18443 - HTTPS)
    ProxyPass / https://127.0.0.1:18443/
    ProxyPassReverse / https://127.0.0.1:18443/
    
    # WebSocket support for Gradio UI
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           wss://127.0.0.1:18443/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           https://127.0.0.1:18443/$1 [P,L]
    
    # Proxy settings
    ProxyTimeout 300
    ProxyBadHeader Ignore
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/tender-ai.yulcom.net-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/tender-ai.yulcom.net-ssl-access.log combined
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
