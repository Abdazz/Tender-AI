# Production override for docker-compose.yml
# This file configures services for production deployment
# 
# In production:
# - Ports are NOT exposed (Nginx reverse proxy handles external access)
# - Pre-built images from GitHub Container Registry are used
# - Resource limits are enforced
#
# This file is copied as docker-compose.override.yml during CI/CD deployment

version: '3.8'

services:
  # Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: tenderai-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Mount existing SSL certificates from host
      - /etc/letsencrypt/live/tender-ai.yulcom.net/fullchain.pem:/etc/nginx/ssl/fullchain.pem:ro
      - /etc/letsencrypt/live/tender-ai.yulcom.net/privkey.pem:/etc/nginx/ssl/privkey.pem:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - api
      - ui
    restart: unless-stopped
    networks:
      - tenderai-network

  # No port exposures needed - all ports are commented in base docker-compose.yml
  # Nginx reverse proxy will forward to:
  # - api:8000 (internal)
  # - ui:7860 (internal)
  # - postgres:5432 (internal only)
  # - minio:9000 (internal only)

  api:
    image: ghcr.io/abdazz/tenderai-bf-api:latest
    build:
      # Don't rebuild in production, use pre-built image
      context: .
      dockerfile: infra/Dockerfile.api
    environment:
      - ENVIRONMENT=production
    # Remove volume mounts for source code in production (use code from image)
    volumes:
      - ./settings.yaml:/app/settings.yaml:ro
      - ./logs:/app/logs
      - api-cache:/app/cache
      - ./alembic:/app/alembic
    # Use production command (no --reload)
    command: ["uvicorn", "tenderai_bf.api.main:app", "--host", "0.0.0.0", "--port", "8000"]
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  ui:
    image: ghcr.io/abdazz/tenderai-bf-ui:latest
    build:
      # Don't rebuild in production, use pre-built image
      context: .
      dockerfile: infra/Dockerfile.ui
    environment:
      - ENVIRONMENT=production
    # Remove volume mounts for source code in production
    volumes:
      - ./settings.yaml:/app/settings.yaml:ro
      - ./logs:/app/logs
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  worker:
    image: ghcr.io/abdazz/tenderai-bf-worker:latest
    build:
      # Don't rebuild in production, use pre-built image
      context: .
      dockerfile: infra/Dockerfile.worker
    environment:
      - ENVIRONMENT=production
    # Remove volume mounts for source code in production
    volumes:
      - ./settings.yaml:/app/settings.yaml:ro
      - ./logs:/app/logs
      - worker-cache:/app/cache
      - worker-temp:/tmp/ocr
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
